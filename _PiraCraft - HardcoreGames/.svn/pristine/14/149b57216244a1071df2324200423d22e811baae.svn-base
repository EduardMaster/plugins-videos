package me.douglasamv.hg;

import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Random;

import org.bukkit.Bukkit;
import org.bukkit.Difficulty;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.Sound;
import org.bukkit.World;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.ShapelessRecipe;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.potion.PotionEffect;
import org.bukkit.scoreboard.DisplaySlot;

import me.douglasamv.hg.Borda.BorderBlocks;
import me.douglasamv.hg.Borda.BorderMove;
import me.douglasamv.hg.Borda.BorderType;
import me.douglasamv.hg.Borda.WorldBorder;
import me.douglasamv.hg.Comandos.Admin;
import me.douglasamv.hg.Comandos.Arena;
import me.douglasamv.hg.Comandos.CMDMiniArena;
import me.douglasamv.hg.Comandos.CMDPvP;
import me.douglasamv.hg.Comandos.CMDSkit;
import me.douglasamv.hg.Comandos.CMDSpec;
import me.douglasamv.hg.Comandos.CMDSpecTp;
import me.douglasamv.hg.Comandos.CMDStart;
import me.douglasamv.hg.Comandos.CMDTell;
import me.douglasamv.hg.Comandos.CMDTimer;
import me.douglasamv.hg.Comandos.CMDVisInvis;
import me.douglasamv.hg.Comandos.CMDWatch;
import me.douglasamv.hg.Comandos.CMDWho;
import me.douglasamv.hg.Comandos.Chat;
import me.douglasamv.hg.Comandos.Check;
import me.douglasamv.hg.Comandos.Feast;
import me.douglasamv.hg.Comandos.Fly;
import me.douglasamv.hg.Comandos.Help;
import me.douglasamv.hg.Comandos.Info;
import me.douglasamv.hg.Comandos.Inv;
import me.douglasamv.hg.Comandos.Kit;
import me.douglasamv.hg.Comandos.KitDisable;
import me.douglasamv.hg.Comandos.KitDisableAll;
import me.douglasamv.hg.Comandos.Kits;
import me.douglasamv.hg.Eventos.ChecarVitoria;
import me.douglasamv.hg.Eventos.Compass;
import me.douglasamv.hg.Eventos.DeathPlayerMSG;
import me.douglasamv.hg.Eventos.DropItem;
import me.douglasamv.hg.Eventos.LoadKits;
import me.douglasamv.hg.Eventos.PreAndamento;
import me.douglasamv.hg.Eventos.PreDeathEvt;
import me.douglasamv.hg.Eventos.PreGameEvt;
import me.douglasamv.hg.Eventos.PreInvencibilidadeEvt;
import me.douglasamv.hg.Eventos.PreJoin;
import me.douglasamv.hg.Habilidades.Anchor;
import me.douglasamv.hg.Habilidades.BackPacker;
import me.douglasamv.hg.Habilidades.Cacto;
import me.douglasamv.hg.Habilidades.CopyCat;
import me.douglasamv.hg.Habilidades.Crafter;
import me.douglasamv.hg.Habilidades.Cultivator;
import me.douglasamv.hg.Habilidades.Demoman;
import me.douglasamv.hg.Habilidades.Dwarf;
import me.douglasamv.hg.Habilidades.Endermage;
import me.douglasamv.hg.Habilidades.Fireman;
import me.douglasamv.hg.Habilidades.Firer;
import me.douglasamv.hg.Habilidades.Fisherman;
import me.douglasamv.hg.Habilidades.Forger;
import me.douglasamv.hg.Habilidades.Gladiator;
import me.douglasamv.hg.Habilidades.Hulk;
import me.douglasamv.hg.Habilidades.Jellyfish;
import me.douglasamv.hg.Habilidades.Kangaroo;
import me.douglasamv.hg.Habilidades.Launcher;
import me.douglasamv.hg.Habilidades.Lumberjack;
import me.douglasamv.hg.Habilidades.Madman;
import me.douglasamv.hg.Habilidades.Miner;
import me.douglasamv.hg.Habilidades.Monk;
import me.douglasamv.hg.Habilidades.Ninja;
import me.douglasamv.hg.Habilidades.Poseidon;
import me.douglasamv.hg.Habilidades.Reaper;
import me.douglasamv.hg.Habilidades.Snail;
import me.douglasamv.hg.Habilidades.Stomper;
import me.douglasamv.hg.Habilidades.Surprise;
import me.douglasamv.hg.Habilidades.Switcher;
import me.douglasamv.hg.Habilidades.Tank;
import me.douglasamv.hg.Habilidades.Thor;
import me.douglasamv.hg.Habilidades.Timelord;
import me.douglasamv.hg.Habilidades.Tower;
import me.douglasamv.hg.Habilidades.Turtle;
import me.douglasamv.hg.Habilidades.Viking;
import me.douglasamv.hg.Habilidades.Viper;
import me.douglasamv.hg.Habilidades.Worm;
import me.douglasamv.hg.Inv.InvKit;
import me.douglasamv.hg.Manager.BarKit;
import me.douglasamv.hg.Manager.EspectadoresManager;
import me.douglasamv.hg.Manager.Habilidade;
import me.douglasamv.hg.Manager.IniciandoEvt;
import me.douglasamv.hg.Manager.SecondEvent;
import me.douglasamv.hg.Timer.Iniciando;
import me.douglasamv.hg.Timer.Invencibilidade;
import me.douglasamv.hg.api.ScoreBoardBolada;

public class Main extends JavaPlugin implements Listener {

	public static Plugin instance;
	public static boolean PreGame;
	public static boolean PreInvencibilidade;
	public static boolean Partida;
	public static boolean Finalizando;
	public static int Andamento = 0;
	public static Integer TimerIniciando = Integer.valueOf(180);
	public static Integer TimerInvencibilidade = Integer.valueOf(120);
	public static FileConfiguration config;
	public static Boolean Feast = Boolean.valueOf(true);
	public static Integer TempoFeast = Integer.valueOf(300);
	public static Boolean BausFeast = Boolean.valueOf(true);
	public static List<String> saiu = new ArrayList<String>();
	public static Integer MinimoJogadores = Integer.valueOf(5);
	public static Boolean ProtecaoFeast = Boolean.valueOf(true);
	public static ArrayList<String> Watch = new ArrayList<String>();
	public static ArrayList<String> mortos = new ArrayList<String>();
	public static ArrayList<String> Relogar = new ArrayList<String>();
	public static ArrayList<String> Jogadores = new ArrayList<String>();
	public static HashMap<String, ItemStack[]> skit = new HashMap<String, ItemStack[]>();
	public static HashMap<String, ItemStack[]> armor = new HashMap<String, ItemStack[]>();
	public static Random RANDOM = new Random();

	public void onLoad() {
		Bukkit.getLogger().info("Removendo mundo!");
		Bukkit.getServer().unloadWorld("world", false);
		deleteDir(new File("world"));
	}

	public static void deleteDir(File dir) {
		if (dir.isDirectory()) {
			String[] children = dir.list();
			for (int i = 0; i < children.length; i++) {
				deleteDir(new File(dir, children[i]));
			}
		}
		dir.delete();
	}

	@EventHandler
	void teste (PlayerCommandPreprocessEvent event) {
		if(event.getMessage().equalsIgnoreCase("/rlscore")) {
			for(Player p:Bukkit.getOnlinePlayers()) {
				p.getScoreboard().clearSlot(DisplaySlot.SIDEBAR);
			}
			event.setCancelled(true);
		}
	}
	
	@SuppressWarnings("deprecation")
	public void onEnable() {
		instance = this;
		PreGame = true;
		new Iniciando();
		new Surprise();
		Jogadores.clear();
		saveDefaultConfig();
		config = getConfig();
		Bukkit.getServer().getPluginManager().registerEvents(this, this);
		Eventos();
		Comandos();
		Arquivos();
		Habilidades();
		Bukkit.getServer().getWorld("world").getLoadedChunks();
		((World) Bukkit.getServer().getWorlds().get(0)).setTime(0L);
		Bukkit.getServer().getWorld("world").setDifficulty(Difficulty.PEACEFUL);

		ItemStack Resultado = new ItemStack(Material.MUSHROOM_SOUP, 1);
		ItemMeta Cactos = Resultado.getItemMeta();
		Resultado.setItemMeta(Cactos);
		ShapelessRecipe CraftCactos = new ShapelessRecipe(Resultado);
		CraftCactos.addIngredient(2, Material.CACTUS);
		CraftCactos.addIngredient(1, Material.BOWL);
		Bukkit.getServer().addRecipe(CraftCactos);

		ItemMeta Cocoa = Resultado.getItemMeta();
		Resultado.setItemMeta(Cocoa);
		ShapelessRecipe CraftCocoa = new ShapelessRecipe(Resultado);
		CraftCocoa.addIngredient(1, Material.INK_SACK, 3);
		CraftCocoa.addIngredient(1, Material.BOWL);
		Bukkit.getServer().addRecipe(CraftCocoa);

		ItemMeta Flores = Resultado.getItemMeta();
		Resultado.setItemMeta(Flores);
		ShapelessRecipe CraftFlores = new ShapelessRecipe(Resultado);
		CraftFlores.addIngredient(1, Material.YELLOW_FLOWER);
		CraftFlores.addIngredient(1, Material.RED_ROSE);
		CraftFlores.addIngredient(1, Material.BOWL);
		Bukkit.getServer().addRecipe(CraftFlores);
		BorderBlocks.GerarBorda();

	}

	public static String tipo() {
		if (PreGame) {
			return "entrar";
		} else {
			return "jogo";
		}
	}

	public void Arquivos() {
		instance = this;
	}

	public static Location getFeastLocation() {
		Random random = new Random();
		Location startFrom = ((World) Bukkit.getWorlds().get(0)).getSpawnLocation();
		Location loc;
		do {
			loc = startFrom.clone();
			loc.add((random.nextBoolean() ? 1 : -1) * random.nextInt(100), 60.0D,
					(random.nextBoolean() ? 1 : -1) * random.nextInt(100));
			int newY = ((World) Bukkit.getWorlds().get(0)).getHighestBlockYAt(loc);
			loc.setY(newY);
		} while (!WorldBorder.inBorder(loc, BorderType.WARN));
		return loc;
	}

	public void onDisable() {
		Jogadores.clear();
		Bukkit.getServer().getScheduler().cancelAllTasks();

	}

	public void Comandos() {
		getCommand("iniciar").setExecutor(new CMDStart());
		getCommand("kits").setExecutor(new Kits());
		getCommand("kit").setExecutor(new Kit());
		getCommand("help").setExecutor(new Help());
		getCommand("admin").setExecutor(new Admin());
		getCommand("chat").setExecutor(new Chat());
		getCommand("checar").setExecutor(new Check());
		getCommand("spec").setExecutor(new CMDSpec());
		getCommand("help").setExecutor(new Help());
		getCommand("info").setExecutor(new Info());
		getCommand("pvp").setExecutor(new CMDPvP());
		getCommand("skit").setExecutor(new CMDSkit());
		getCommand("miniarena").setExecutor(new CMDMiniArena());
		getCommand("ir").setExecutor(new CMDSpecTp());
		getCommand("who").setExecutor(new CMDWho());
		getCommand("fly").setExecutor(new Fly());
		getCommand("feast").setExecutor(new Feast());
		getCommand("tell").setExecutor(new CMDTell());
		getCommand("arena").setExecutor(new Arena());
		getCommand("inv").setExecutor(new Inv());
		getCommand("tpall").setExecutor(new CMDTimer());
		getCommand("invencibilidade").setExecutor(new CMDTimer());
		getCommand("game").setExecutor(new CMDTimer());
		getCommand("pregame").setExecutor(new CMDTimer());
		getCommand("invis").setExecutor(new Check());
		getCommand("vis").setExecutor(new CMDVisInvis());
		getCommand("toggle").setExecutor(new KitDisableAll());
		getCommand("togglekit").setExecutor(new KitDisable());
		getCommand("watch").setExecutor(new CMDWatch());
	}

	public void Eventos() {
		Bukkit.getServer().getPluginManager().registerEvents(new PreGameEvt(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new IniciandoEvt(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new PreInvencibilidadeEvt(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new PreDeathEvt(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new PreAndamento(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new me.douglasamv.hg.Comandos.Listener(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new CMDMiniArena(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new DeathPlayerMSG(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new InvKit(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new KitDisable(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new DropItem(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new BarKit(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new BorderMove(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new PreJoin(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new ChecarVitoria(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new EspectadoresManager(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Compass(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Admin(), this);
	}

	public void Habilidades() {
		Bukkit.getServer().getPluginManager().registerEvents(new Firer(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Crafter(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Cultivator(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Demoman(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Dwarf(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Endermage(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Fisherman(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Tower(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Forger(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Cacto(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new CopyCat(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Gladiator(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Viking(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Fireman(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Hulk(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Jellyfish(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Kangaroo(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Lumberjack(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new BackPacker(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Miner(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Anchor(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Monk(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Ninja(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Poseidon(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Reaper(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Snail(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Stomper(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Switcher(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new BackPacker(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Madman(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Tank(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Surprise(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Thor(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Timelord(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Launcher(this), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Turtle(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Viper(), this);
		Bukkit.getServer().getPluginManager().registerEvents(new Worm(), this);
		Bukkit.getServer().getScheduler().scheduleSyncRepeatingTask(this, new Runnable() {
			public void run() {
				Bukkit.getPluginManager().callEvent(new SecondEvent());
			}
		}, 20L, 60L);
	}

	@EventHandler
	public void CommandPartida(final PlayerCommandPreprocessEvent event) {
		Player p = event.getPlayer();
		if ((Main.Partida) && (event.getMessage().toLowerCase().startsWith("/kit "))) {
			p.sendMessage("§cDesculpe a partida ja esta em andamento!");
			event.setCancelled(true);
			return;
		}
	}

	ArrayList<String> NoKit = new ArrayList<String>();

	@EventHandler
	public void NoKit(final PlayerCommandPreprocessEvent event) {
		Player p = event.getPlayer();
		if ((NoKit.contains(p.getName())) && (event.getMessage().toLowerCase().startsWith("/kit "))) {
			p.sendMessage("§cDesculpe a partida ja esta em andamento!");
			event.setCancelled(true);
			return;
		}
	}

	@EventHandler
	public void KitAndamento(final PlayerCommandPreprocessEvent e) {
		Player p = e.getPlayer();
		if ((PreInvencibilidade)) {
			if (Habilidade.getAbility(p).equalsIgnoreCase("Nenhum") && (p.hasPermission("HungerGames.Kit5m"))) {
				if (e.getMessage().contains("/kit ")) {
					e.setCancelled(false);
					Bukkit.getServer().getScheduler().scheduleSyncDelayedTask(Main.instance, new Runnable() {
						public void run() {
							LoadKits.CheckKits(p);
							NoKit.add(p.getName());
							for (PotionEffect effect : p.getActivePotionEffects()) {
								p.removePotionEffect(effect.getType());
							}
							if (Habilidade.getAbility(p).equalsIgnoreCase("cacto")) {
								Cacto.RecraftCactus(p);
							}
							if (Habilidade.getAbility(p).equalsIgnoreCase("Surprise")) {
								Surprise.setSurprise(p);
							}
						}
					}, 25L);
				}
			} else {
				if (e.getMessage().contains("/kit ")) {
					e.setCancelled(true);
				}
			}
		}
	}

	public static void IniciarPartida() {
		Iniciando.cancel();
		for (Player Participando : Bukkit.getOnlinePlayers()) {
			ScoreBoardBolada.removeScore(Participando);
			if (Jogadores.contains(Participando.getName())) {
				Iniciando.RelogPreGame.remove(Participando);
				Participando.setAllowFlight(false);
				Participando.playSound(Participando.getLocation(), Sound.AMBIENCE_THUNDER, 4.0F, 4.0F);
				Participando.setFlying(false);
				Participando.getInventory().clear();
				Participando.getInventory().addItem(new ItemStack(Material.COMPASS));
				LoadKits.CheckKits(Participando);
				Participando.setHealth(20);
				Participando.setFoodLevel(20);
				Participando.setFireTicks(0);
				Participando.setExhaustion(20.0F);
				if (Habilidade.getAbility(Participando).equalsIgnoreCase("Surprise")) {
					Surprise.setSurprise(Participando);
				}
				if (Habilidade.getAbility(Participando).equalsIgnoreCase("cacto")) {
					Cacto.RecraftCactus(Participando);
				}
			}
		}
		new Invencibilidade();
		Main.PreGame = false;
		KitDisable.KitsDisable = false;
		Main.PreInvencibilidade = true;
		IniciandoEvt.Teleportar = false;
		((World) Bukkit.getServer().getWorlds().get(0)).setTime(0L);
		((World) Bukkit.getServer().getWorlds().get(0)).setStorm(false);
		((World) Bukkit.getServer().getWorlds().get(0)).setThundering(false);

	}
}